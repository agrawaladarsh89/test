{% extends "base.html" %}

{% block content %}
<div class="row">
    <!-- Configuration Column -->
    <div class="col-md-8">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-cog"></i> Configuration</h5>
            </div>
            <div class="card-body">
                <form method="POST" id="configForm">
                    <!-- Project Selection -->
                    <div class="mb-3">
                        <label for="project" class="form-label">Select Project:</label>
                        <select class="form-select" id="project" name="project" required>
                            <option value="">Select a project...</option>
                            {% for project in projects %}
                            <option value="{{ project }}" {% if project == selected_project %}selected{% endif %}>
                                {{ project }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Service Selection -->
                    <div class="mb-3">
                        <label for="service" class="form-label">Select Service:</label>
                        <select class="form-select" id="service" name="service" {% if not selected_project %}disabled{% endif %} required>
                            <option value="">
                                {% if not selected_project %}
                                    Please select a project first to load services
                                {% else %}
                                    Select a service...
                                {% endif %}
                            </option>
                            {% for service in services %}
                            <option value="{{ service }}" {% if service == selected_service %}selected{% endif %}>
                                {{ service }}
                            </option>
                            {% endfor %}
                        </select>
                        <div id="serviceLoading" class="text-muted mt-1" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i> Loading services...
                        </div>
                        {% if service_error %}
                        <div class="alert alert-warning mt-2" role="alert">
                            <i class="fas fa-exclamation-triangle"></i> {{ service_error }}
                        </div>
                        {% endif %}
                    </div>

                    <!-- Action Selection -->
                    <div class="mb-3">
                        <label for="todo" class="form-label">Select Action:</label>
                        <select class="form-select" id="todo" name="todo" required>
                            <option value="">Select an action...</option>
                            {% for todo in todo_options %}
                            <option value="{{ todo }}" {% if todo == selected_todo %}selected{% endif %}>
                                {{ todo }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <hr>

                    <!-- Status and Command Display -->
                    {% if all_selected %}
                    <div class="alert alert-success" role="alert">
                        <i class="fas fa-check-circle"></i> All options selected. Ready to run command.
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Command to execute:</label>
                        <div class="command-display">{{ command }}</div>
                        <input type="hidden" name="command" value="{{ command }}">
                    </div>
                    <button type="submit" class="btn btn-success btn-lg w-100" formaction="/confirm">
                        <i class="fas fa-rocket"></i> Run Command
                    </button>
                    {% else %}
                    <div class="alert alert-warning" role="alert">
                        <i class="fas fa-exclamation-triangle"></i> 
                        Please select: {{ missing_items | join(', ') }}
                    </div>
                    <button type="button" class="btn btn-success btn-lg w-100" disabled>
                        <i class="fas fa-rocket"></i> Run Command
                    </button>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>

    <!-- Status Column -->
    <div class="col-md-4">
        <div class="card shadow-sm status-card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle"></i> Current Selection</h5>
            </div>
            <div class="card-body">
                <div class="selection-card p-3 mb-2 rounded">
                    <strong>Project:</strong> {{ selected_project or 'Not selected' }}
                </div>
                <div class="selection-card p-3 mb-2 rounded">
                    <strong>Service:</strong> {{ selected_service or 'Not selected' }}
                </div>
                <div class="selection-card p-3 mb-3 rounded">
                    <strong>Action:</strong> {{ selected_todo or 'Not selected' }}
                </div>
                
                {% if services and selected_project %}
                <div class="alert alert-success" role="alert">
                    <i class="fas fa-check-circle"></i> 
                    Found {{ service_count }} services for project {{ selected_project }}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('project').addEventListener('change', function() {
    const project = this.value;
    const serviceSelect = document.getElementById('service');
    const serviceLoading = document.getElementById('serviceLoading');
    const form = document.getElementById('configForm');
    
    if (!project) {
        serviceSelect.innerHTML = '<option value="">Please select a project first to load services</option>';
        serviceSelect.disabled = true;
        return;
    }
    
    // Show loading state
    serviceLoading.style.display = 'block';
    serviceSelect.disabled = true;
    serviceSelect.innerHTML = '<option value="">Loading services...</option>';
    form.classList.add('loading');
    
    // Make AJAX request to get services
    axios.post('/get_services', {
        project: project
    })
    .then(function(response) {
        const services = response.data.services;
        const count = response.data.count;
        
        // Update service dropdown
        serviceSelect.innerHTML = '<option value="">Select a service...</option>';
        services.forEach(function(service) {
            const option = document.createElement('option');
            option.value = service;
            option.textContent = service;
            serviceSelect.appendChild(option);
        });
        
        serviceSelect.disabled = false;
        
        // Update the form to refresh the page with new services
        form.submit();
    })
    .catch(function(error) {
        console.error('Error loading services:', error);
        serviceSelect.innerHTML = '<option value="">Error loading services</option>';
        serviceSelect.disabled = false;
    })
    .finally(function() {
        serviceLoading.style.display = 'none';
        form.classList.remove('loading');
    });
});

// Auto-submit form when selections change (to update the command display)
document.getElementById('service').addEventListener('change', function() {
    if (this.value) {
        document.getElementById('configForm').submit();
    }
});

document.getElementById('todo').addEventListener('change', function() {
    if (this.value) {
        document.getElementById('configForm').submit();
    }
});
</script>
{% endblock %}
