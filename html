<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCM Lifecycle Management</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl mx-4">
        <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">PCM Lifecycle Management</h1>
        
        <form id="pcm-form" class="space-y-6">
            <!-- Project Dropdown -->
            <div>
                <label for="project-select" class="block text-sm font-medium text-gray-700">Select Project</label>
                <select id="project-select" name="project" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                    <option value="" disabled selected>-- Select a Project --</option>
                    {% for project in projects %}
                    <option value="{{ project }}">{{ project }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Service Name Dropdown (Auto-populated) -->
            <div>
                <label for="service-select" class="block text-sm font-medium text-gray-700">Select Service Name</label>
                <select id="service-select" name="service" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm" disabled>
                    <option value="" disabled selected>-- Select a Project first --</option>
                </select>
            </div>

            <!-- Todo Dropdown -->
            <div>
                <label for="todo-select" class="block text-sm font-medium text-gray-700">Select Action</label>
                <select id="todo-select" name="todo" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                    <option value="" disabled selected>-- Select an Action --</option>
                    {% for todo in todos %}
                    <option value="{{ todo }}">{{ todo }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Run Button -->
            <button id="run-button" type="button" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200" disabled>
                Run Command
            </button>
        </form>

        <!-- Command Confirmation Modal -->
        <div id="confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Confirm Action</h3>
                    <div class="mt-2 px-7 py-3">
                        <p id="confirm-message" class="text-sm text-gray-500"></p>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="confirm-yes" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-24 mr-2 shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300 transition-colors duration-200">Yes</button>
                        <button id="confirm-no" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-24 shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300 transition-colors duration-200">No</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Result/Output Box -->
        <div id="result-box" class="mt-8 p-4 bg-gray-200 text-gray-700 rounded-md hidden">
            <p id="result-message" class="font-mono text-sm"></p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const projectSelect = document.getElementById('project-select');
            const serviceSelect = document.getElementById('service-select');
            const todoSelect = document.getElementById('todo-select');
            const runButton = document.getElementById('run-button');
            const confirmationModal = document.getElementById('confirmation-modal');
            const confirmMessage = document.getElementById('confirm-message');
            const confirmYesButton = document.getElementById('confirm-yes');
            const confirmNoButton = document.getElementById('confirm-no');
            const resultBox = document.getElementById('result-box');
            const resultMessage = document.getElementById('result-message');

            const checkFormStatus = () => {
                const projectSelected = projectSelect.value !== '';
                const serviceSelected = serviceSelect.value !== '';
                const todoSelected = todoSelect.value !== '';
                runButton.disabled = !(projectSelected && serviceSelected && todoSelected);
            };

            const fetchServices = async (projectName) => {
                try {
                    const response = await fetch('/get_services', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ project: projectName })
                    });
                    const data = await response.json();
                    return data.services;
                } catch (error) {
                    console.error('Error fetching services:', error);
                    return [];
                }
            };

            projectSelect.addEventListener('change', async (event) => {
                const selectedProject = event.target.value;
                serviceSelect.disabled = true;
                serviceSelect.innerHTML = '<option value="" disabled selected>Loading services...</option>';
                checkFormStatus();

                const services = await fetchServices(selectedProject);
                
                let optionsHtml = '<option value="" disabled selected>-- Select a Service --</option>';
                services.forEach(service => {
                    optionsHtml += `<option value="${service}">${service}</option>`;
                });
                serviceSelect.innerHTML = optionsHtml;
                serviceSelect.disabled = false;
                checkFormStatus();
            });

            serviceSelect.addEventListener('change', checkFormStatus);
            todoSelect.addEventListener('change', checkFormStatus);

            runButton.addEventListener('click', () => {
                const project = projectSelect.value;
                const service = serviceSelect.value;
                const todo = todoSelect.value;
                
                confirmMessage.textContent = `Are you sure you want to run the command: pcm ${todo} ${project} ${service}?`;
                confirmationModal.classList.remove('hidden');
            });

            confirmYesButton.addEventListener('click', async () => {
                confirmationModal.classList.add('hidden');
                
                const project = projectSelect.value;
                const service = serviceSelect.value;
                const todo = todoSelect.value;

                try {
                    const response = await fetch('/run_command', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ project, service, todo })
                    });
                    const result = await response.json();

                    if (result.status === 'success') {
                        resultMessage.textContent = `Command successfully prepared: "${result.command}"`;
                        resultBox.classList.remove('hidden');
                        resultBox.classList.add('bg-green-100', 'text-green-800');
                        resultBox.classList.remove('bg-red-100', 'text-red-800');
                    } else {
                        resultMessage.textContent = `Error: ${result.message}`;
                        resultBox.classList.remove('hidden');
                        resultBox.classList.add('bg-red-100', 'text-red-800');
                        resultBox.classList.remove('bg-green-100', 'text-green-800');
                    }

                } catch (error) {
                    console.error('Error running command:', error);
                    resultMessage.textContent = `An unexpected error occurred: ${error.message}`;
                    resultBox.classList.remove('hidden');
                    resultBox.classList.add('bg-red-100', 'text-red-800');
                    resultBox.classList.remove('bg-green-100', 'text-green-800');
                }
            });

            confirmNoButton.addEventListener('click', () => {
                confirmationModal.classList.add('hidden');
            });
        });
    </script>
</body>
</html>
